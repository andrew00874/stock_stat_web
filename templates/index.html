<!DOCTYPE html>
<html lang="ko">
  <head>
    <meta charset="UTF-8" />
    <title>옵션 분석기</title>
    <link rel="stylesheet" href="https://cdn.simplecss.org/simple.min.css" />
    <style>
      main {
        max-width: 600px;
        margin: auto;
      }
      .hidden {
        display: none;
      }
    </style>
    <script
      async
      src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-3645359139957527"
      crossorigin="anonymous"
    ></script>
  </head>
  <body>
    <header>
      <h1>옵션 데이터 분석기</h1>
      <p>분석할 주식 티커를 입력하세요. (예: SPY, AAPL, TSLA)</p>
    </header>
    <main>
      <div>
        <label for="ticker-input">티커:</label>
        <input type="text" id="ticker-input" placeholder="SPY" />
        <button id="fetch-button">만기일 불러오기</button>
      </div>
      <p id="message-area" class="notice"></p>

      <form id="report-form" action="/report" method="post" class="hidden">
        <input type="hidden" name="ticker" id="hidden-ticker" />
        <label for="expiry-select">만기일 선택:</label>
        <select name="expiry_date" id="expiry-select"></select>
        <button type="submit">분석 리포트 보기</button>
      </form>
    </main>

    <script>
      const tickerInput = document.getElementById("ticker-input");
      const fetchButton = document.getElementById("fetch-button");
      const messageArea = document.getElementById("message-area");
      const reportForm = document.getElementById("report-form");
      const expirySelect = document.getElementById("expiry-select");
      const hiddenTicker = document.getElementById("hidden-ticker");

      fetchButton.addEventListener("click", async () => {
        const ticker = tickerInput.value.trim().toUpperCase();
        if (!ticker) {
          messageArea.textContent = "티커를 입력해주세요.";
          return;
        }
        messageArea.textContent = `${ticker} 만기일을 불러오는 중...`;
        reportForm.classList.add("hidden");

        try {
          const response = await fetch(`/get-expiries?ticker=${ticker}`);
          const data = await response.json();

          if (response.ok) {
            expirySelect.innerHTML = "";
            data.forEach((date) => {
              const option = new Option(date, date);
              expirySelect.add(option);
            });
            hiddenTicker.value = ticker;
            reportForm.classList.remove("hidden");
            messageArea.textContent = `만기일을 선택하고 분석하세요.`;
          } else {
            messageArea.textContent = `오류: ${data.error}`;
          }
        } catch (error) {
          messageArea.textContent = "서버 통신 중 오류가 발생했습니다.";
        }
      });
    </script>
  </body>
</html>
